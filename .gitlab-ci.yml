# This file is auto-generated by DevPlatform for further customizing as you wish.
# NOTE: You should not delete this file!

variables:
  DOCKER_TLS_CERTDIR: /docker-certs
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: ${DOCKER_TLS_CERTDIR}/client
  DOCKER_PROXY: docker-proxy.artifactory.tcsbank.ru
  DOCKER_REGISTRY: docker-hosted.artifactory.tcsbank.ru
  
  HTTPS_PROXY: http://proxy.tcsbank.ru:8080
  HTTP_PROXY: http://proxy.tcsbank.ru:8080
  http_proxy: http://proxy.tcsbank.ru:8080
  https_proxy: http://proxy.tcsbank.ru:8080
  no_proxy: 'docker,.tinkoff.cloud,.tcsbank.ru,.tinkoff.ru'
  
  GOPROXY: "https://athens.tcsbank.ru:3000"
  GOPRIVATE: "*.tcsbank.ru,*.tinkoff.cloud"
  GOLANG_VERSION: "1.17"
  
  SERVICE_NAME: clickhouse-proxy-server
  IMAGE_TAG: $CI_COMMIT_SHA
  DOCKER_IMAGE: "${DOCKER_REGISTRY}/${CI_PROJECT_NAMESPACE}/${SERVICE_NAME}:${PREFIX}-${IMAGE_TAG}"

  CLICKHOUSE_PROD_NODES: "[
      \"rc1a-0frj3mcfce5fg8f9.mdb.yandexcloud.net:8123\",
      \"rc1a-dntfp0qefgqql8pa.mdb.yandexcloud.net:8123\",
      \"rc1a-e3efds88ij1jfb9t.mdb.yandexcloud.net:8123\",
      \"rc1b-gfntqgsjpc1jf4j7.mdb.yandexcloud.net:8123\",
      \"rc1b-l6a1c3l1sbu68tlu.mdb.yandexcloud.net:8123\",
      \"rc1b-nlp8ractq35qp66l.mdb.yandexcloud.net:8123\",
      \"rc1a-a4tgkl56e7gon3po.mdb.yandexcloud.net:8123\",
      \"rc1a-nf4gvv3b9vfp1aag.mdb.yandexcloud.net:8123\",
      \"rc1b-toobdjh1m4ea4fdb.mdb.yandexcloud.net:8123\",
      \"rc1a-rne1s41ncfo31rgc.mdb.yandexcloud.net:8123\",
      \"rc1a-tu5o61jb0smd0e3a.mdb.yandexcloud.net:8123\",
      \"rc1b-b5hdlvnhmamlps6t.mdb.yandexcloud.net:8123\",
      \"rc1a-murd3mg352rfs1k4.mdb.yandexcloud.net:8123\",
      \"rc1a-rqeckt6u63i89llk.mdb.yandexcloud.net:8123\",
      \"rc1b-o9n0tupomf2vptq7.mdb.yandexcloud.net:8123\",
      \"rc1a-4juimdn3er8rv8rm.mdb.yandexcloud.net:8123\",
      \"rc1a-lnetom4vhknpbi0f.mdb.yandexcloud.net:8123\",
      \"rc1b-he9vk6o8a6921g6s.mdb.yandexcloud.net:8123\",
      \"rc1a-0accmgt9s9fg6lcd.mdb.yandexcloud.net:8123\",
      \"rc1a-bj29kq9t6ctgt1aa.mdb.yandexcloud.net:8123\",
      \"rc1b-o2sncn2v8h6fqe65.mdb.yandexcloud.net:8123\",
      \"rc1a-het3vjeadb047ua1.mdb.yandexcloud.net:8123\",
      \"rc1a-uub1maaelhkrqfgl.mdb.yandexcloud.net:8123\",
      \"rc1b-348gi0cmvdiceuj9.mdb.yandexcloud.net:8123\",
      \"rc1a-omju28nn26nt4bev.mdb.yandexcloud.net:8123\",
      \"rc1b-2i0g5522uq3mta30.mdb.yandexcloud.net:8123\",
      \"rc1b-mvqep963urbt3gqm.mdb.yandexcloud.net:8123\",
      \"rc1a-ovuaa3ejfvdf0kuv.mdb.yandexcloud.net:8123\",
      \"rc1b-enudv3jrm9shms3j.mdb.yandexcloud.net:8123\",
      \"rc1b-k66c8sgv9a2hkh94.mdb.yandexcloud.net:8123\"
    ]"
  CLICKHOUSE_PROD2_NODES: "[
      \"rc1a-clqopju5gb59spok.mdb.yandexcloud.net:8123\",
      \"rc1a-joklj9ja6abfsem1.mdb.yandexcloud.net:8123\",
      \"rc1b-9dva927pkj6qggrq.mdb.yandexcloud.net:8123\",
      \"rc1a-c2v5tlsinpaumobd.mdb.yandexcloud.net:8123\",
      \"rc1a-jjmmrr06clgk5p55.mdb.yandexcloud.net:8123\",
      \"rc1b-99q8qfe934065qni.mdb.yandexcloud.net:8123\",
      \"rc1a-a1bdsfpm0tfat1ip.mdb.yandexcloud.net:8123\",
      \"rc1a-adrac6i3dvsnstgd.mdb.yandexcloud.net:8123\",
      \"rc1b-q8r8vg0bimteblit.mdb.yandexcloud.net:8123\",
      \"rc1a-gcjsj44b3mt8vjdf.mdb.yandexcloud.net:8123\",
      \"rc1a-grejumiquh6g2acs.mdb.yandexcloud.net:8123\",
      \"rc1b-5ucembmo9f0pojhj.mdb.yandexcloud.net:8123\",
      \"rc1a-m1k2tgh6q0ekctkb.mdb.yandexcloud.net:8123\",
      \"rc1a-ml4jsnqek4tp1o6m.mdb.yandexcloud.net:8123\",
      \"rc1b-dchbjhbjijrqu146.mdb.yandexcloud.net:8123\",
      \"rc1a-5g1o97kfjfkpafad.mdb.yandexcloud.net:8123\",
      \"rc1a-l2ntk7lameeu37of.mdb.yandexcloud.net:8123\",
      \"rc1b-48p8i01060uqv1ft.mdb.yandexcloud.net:8123\",
      \"rc1a-844i9ero6esunbi0.mdb.yandexcloud.net:8123\",
      \"rc1a-b400rs3jq1qb92l2.mdb.yandexcloud.net:8123\",
      \"rc1b-hf2dt87eudbt3ff5.mdb.yandexcloud.net:8123\",
      \"rc1a-82oif7ja065br7jm.mdb.yandexcloud.net:8123\",
      \"rc1a-ps6e3b18971r2lpf.mdb.yandexcloud.net:8123\",
      \"rc1b-vep17kobunb16ogr.mdb.yandexcloud.net:8123\",
      \"rc1a-f1d4679qchsm9ce3.mdb.yandexcloud.net:8123\",
      \"rc1a-huuudlmoel2tv74e.mdb.yandexcloud.net:8123\",
      \"rc1b-o8m7nbvss1nmiho0.mdb.yandexcloud.net:8123\",
      \"rc1a-16eibt76u3nmqujb.mdb.yandexcloud.net:8123\",
      \"rc1a-2rpsa7vld1n6pp6k.mdb.yandexcloud.net:8123\",
      \"rc1b-va5ooccdqjslq5qk.mdb.yandexcloud.net:8123\"
    ]"
  CLICKHOUSE_DEV_NODES: "[
      \"rc1a-86su01nci1umvb8j.mdb.yandexcloud.net:8123\",
      \"rc1a-8l6i96v0amf7i28j.mdb.yandexcloud.net:8123\",
      \"rc1a-t6s2fbn8svh1aq11.mdb.yandexcloud.net:8123\",
      \"rc1b-9lvltuf7mkuiud58.mdb.yandexcloud.net:8123\",
      \"rc1b-g3g5pu5qavrb67d9.mdb.yandexcloud.net:8123\",
      \"rc1b-pu7kedgcdhk82e4m.mdb.yandexcloud.net:8123\",
    ]"
  CLICKHOUSE_USER_PROD: $CLICKHOUSE_USER_PROD
  CLICKHOUSE_PASSWORD_PROD: $CLICKHOUSE_PASSWORD_PROD
  CLICKHOUSE_PASSWORD_PROD2: $CLICKHOUSE_PASSWORD_PROD2
  CLICKHOUSE_USER_TEST: $CLICKHOUSE_USER_TEST
  CLICKHOUSE_PASSWORD_TEST: $CLICKHOUSE_PASSWORD_TEST
  CLICKHOUSE_PROJECT_OWNER_USER_DEV: $CLICKHOUSE_PROJECT_OWNER_USER_DEV
  CLICKHOUSE_PROJECT_OWNER_PASSWORD_DEV: $CLICKHOUSE_PROJECT_OWNER_PASSWORD_DEV
  CLICKHOUSE_PROJECT_OWNER_USER: $CLICKHOUSE_PROJECT_OWNER_USER_PROD
  CLICKHOUSE_PROJECT_OWNER_PASSWORD: $CLICKHOUSE_PROJECT_OWNER_PASSWORD_PROD
  CLICKHOUSE_DWH_USER: $CLICKHOUSE_DWH_USER
  CLICKHOUSE_DWH_PASSWORD: $CLICKHOUSE_DWH_PASSWORD
  CLICKHOUSE_CHARTS_USER: $CLICKHOUSE_CHARTS_USER
  CLICKHOUSE_CHARTS_PASSWORD: $CLICKHOUSE_CHARTS_PASSWORD
  CLICKHOUSE_SME_USER: $CLICKHOUSE_SME_USER
  CLICKHOUSE_SME_PASSWORD: $CLICKHOUSE_SME_PASSWORD
  CLICKHOUSE_DCO_USER: $CLICKHOUSE_DCO_USER
  CLICKHOUSE_DCO_PASSWORD: $CLICKHOUSE_DCO_PASSWORD
  CLICKHOUSE_VOIP_TEAM_USER: $CLICKHOUSE_VOIP_TEAM_USER
  CLICKHOUSE_VOIP_TEAM_PASSWORD: $CLICKHOUSE_VOIP_TEAM_PASSWORD
  CLICKHOUSE_REDALERT_USER: $CLICKHOUSE_REDALERT_USER
  CLICKHOUSE_REDALERT_PASSWORD: $CLICKHOUSE_REDALERT_PASSWORD
  CLICKHOUSE_MB_ANALYTICS_USER: $CLICKHOUSE_MB_ANALYTICS_USER
  CLICKHOUSE_MB_ANALYTICS_PASSWORD: $CLICKHOUSE_MB_ANALYTICS_PASSWORD
  CLICKHOUSE_DWH_NIFI_USER: $CLICKHOUSE_DWH_NIFI_USER
  CLICKHOUSE_DWH_NIFI_PASSWORD: $CLICKHOUSE_DWH_NIFI_PASSWORD
  CLICKHOUSE_DWH_NIFI_HISTORICAL_USER: $CLICKHOUSE_DWH_NIFI_HISTORICAL_USER
  CLICKHOUSE_DWH_NIFI_HISTORICAL_PASSWORD: $CLICKHOUSE_DWH_NIFI_HISTORICAL_PASSWORD
  CLICKHOUSE_ANALYTICS_SERVICE_USER: $CLICKHOUSE_ANALYTICS_SERVICE_USER
  CLICKHOUSE_ANALYTICS_SERVICE_PASSWORD: $CLICKHOUSE_ANALYTICS_SERVICE_PASSWORD
  REDIS_PASSWORD: $YANDEX_CLOUD_REDIS_CACHE_PASSWORD_PROD

stages:
  - build
  - deploy-secrets
  - deploy

.build-base:
  image:
    name: docker-hosted.artifactory.tcsbank.ru/cicd-images/base-kaniko:release-v1.8.12
  before_script:
    - dp auth service-acc --key-file $DP_DEPLOY_SERVICE_KEY # в переменной должен лежать ключ сервис-аккаунта
    - dp auth configure-kaniko # настройка kaniko (токен действует 1 час)
  script:
    - echo "build and push to ${DOCKER_IMAGE}"
    - IMAGE_CHECK_OUTPUT=$(dp jfrog rt s "${IMAGE_NAME_FOR_CHECK}" 2>&1)
    - echo ${IMAGE_CHECK_OUTPUT}
    - |- 
      if $( echo ${IMAGE_CHECK_OUTPUT} | grep -q "Found 0 artifacts" )
      then
        executor --dockerfile $CI_PROJECT_DIR/Dockerfile \
                  --destination "${DOCKER_IMAGE}" \
                  --log-timestamp \
                  -v warn
        echo "pushed to ${DOCKER_IMAGE}"
      else
        echo "image ${DOCKER_IMAGE} already exist"
      fi
  variables:
    IMAGE_NAME_FOR_CHECK: "docker-hosted/${CI_PROJECT_NAMESPACE}/${SERVICE_NAME}/${PREFIX}-${IMAGE_TAG}/*"
    PREFIX: stable

build:
  extends:
    - .build-base
  stage: build
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

.deploy-secret-base:
  image: docker-hosted.artifactory.tcsbank.ru/cicd-images/base-focal
  stage: deploy-secrets
  before_script:
    - dp auth service-acc --key-file "${DP_DEPLOY_SERVICE_KEY}"
    - echo "deb [trusted=yes] http://apt-proxy.tcsbank.ru/repository/apt-ubuntu/ focal main restricted universe multiverse" > /etc/apt/sources.list && echo "deb [trusted=yes] http://apt-proxy.tcsbank.ru/repository/apt-ubuntu/ focal-updates main restricted universe multiverse" >> /etc/apt/sources.list && echo "deb [trusted=yes] http://apt-proxy.tcsbank.ru/repository/apt-ubuntu/ focal-backports main restricted universe multiverse" >> /etc/apt/sources.list && echo "deb [trusted=yes] http://apt-proxy.tcsbank.ru/repository/apt-ubuntu/ focal-security main restricted universe multiverse" >> /etc/apt/sources.list
    - apt-get update -y && apt-get install gettext-base -y
  script:
    - dp auth configure-kubeconfig --cluster-name $K8S_CLUSTER_NAME_PROD --account-name "$DP_DEPLOY_SA_NAME"
    - envsubst < ./${CONFIG_PATH} | kubectl apply -f -
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      allow_failure: true
      when: manual

deploy-secret-m1-prod2:
  extends:
    - .deploy-secret-base
  variables:
    K8S_CLUSTER_NAME_PROD: m1-prod2.prod
    CLICKHOUSE_NODES: $CLICKHOUSE_PROD_NODES
    CONFIG_PATH: secret.template.yml

deploy-secret-ds-prod2:
  extends:
    - .deploy-secret-base
  variables:
    K8S_CLUSTER_NAME_PROD: ds-prod2.prod
    CLICKHOUSE_NODES: $CLICKHOUSE_PROD_NODES
    CONFIG_PATH: secret.template.yml

deploy-secret-ix-prod2:
  extends:
    - .deploy-secret-base
  variables:
    K8S_CLUSTER_NAME_PROD: ix-m2-prod2.prod
    CLICKHOUSE_NODES: $CLICKHOUSE_PROD_NODES
    CONFIG_PATH: secret.template.yml

deploy-secret-ya-ruc1-dev1:
  extends:
    - .deploy-secret-base
  variables:
    K8S_CLUSTER_NAME_PROD: ya-ruc1-dev1.dev
    CLICKHOUSE_NODES: $CLICKHOUSE_DEV_NODES
    CONFIG_PATH: secret.template.dev.yml

.deploy-base:
  image: docker-hosted.artifactory.tcsbank.ru/unic/unic-main-container-1:latest
  stage: deploy
  script:
    - echo "${IMAGE}"
    - unic deploy --app "${SERVICE_NAME}" --stand "${CLUSTER}" --dockerImage "${DOCKER_IMAGE}"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      allow_failure: true
      when: manual


deploy-prod:
  extends:
    - .deploy-base
  variables:
    PREFIX: stable
    CLUSTER: prod2

deploy-dev:
  extends:
    - .deploy-base
  variables:
    PREFIX: stable
    CLUSTER: dev
